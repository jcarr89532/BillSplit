name: Deploy Lambdas on push to main

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write     # required for GitHub OIDC
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fn:
          - { folder: "getUploadURL", lambda_name: "getUploadURL" }
          - { folder: "ocrExtraction", lambda_name: "ocrExtraction" }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Zip ${{ matrix.fn.lambda_name }}
        run: |
          cd backend/aws/functions/${{ matrix.fn.folder }}
          zip -r ../../../../build-${{ matrix.fn.lambda_name }}.zip . -x "*.git*" "*.pyc" "__pycache__/*"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::496707410440:role/Programmatic-Deployment
          aws-region: us-west-1

      - name: Update Lambda ${{ matrix.fn.lambda_name }}
        run: |
          aws lambda update-function-code \
            --function-name ${{ matrix.fn.lambda_name }} \
            --zip-file fileb://build-${{ matrix.fn.lambda_name }}.zip \
            --publish
